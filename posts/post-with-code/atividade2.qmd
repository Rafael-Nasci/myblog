---
title: "Atividade 2 — Monitoramento da Frota de Ônibus"
format:
  html:
    code-fold: true
    code-summary: "Mostrar código"
execute:
  echo: true
  warning: false
  message: false
---

```{python}
import os
import requests
from dotenv import load_dotenv
import folium

# Carregar token do .env
load_dotenv(".env")
TOKEN = os.getenv
("ONIBUS_TOKEN")   # <-- CORREÇÃO AQUI
API = "http://api.olhovivo.sptrans.com.br/v2.1"

# Linha desejada
linha_usuario = "2506"

# Autenticação
s = requests.Session()
res = s.post(f"{API}/Login/Autenticar?token={TOKEN}")
print("Autenticação:", res.text)


# -------- FUNÇÕES --------

def buscar_codigos(entrada):
    termo = entrada.split("-")[0]
    r = s.get(f"{API}/Linha/Buscar?termosBusca={termo}")
    dados = r.json()

    print("\nLinhas encontradas:")
    for d in dados:
        print(d)

    return [d["cl"] for d in dados]


def buscar_itinerario(cod):
    r = s.get(f"{API}/Itinerario?codigoLinha={cod}")
    data = r.json()

    traj = []
    paradas = []

    for k, v in data.items():
        if k.isdigit():
            traj.append([v["py"], v["px"]])
        elif k.startswith("p"):
            paradas.append({
                "nome": v["np"],
                "lat": v["py"],
                "lng": v["px"]
            })

    return traj, paradas


def buscar_posicao(cod):
    r = s.get(f"{API}/Posicao/Linha?codigoLinha={cod}")
    dados = r.json()
    return dados.get("vs", [])


# -------- PROCESSAMENTO --------

todos_codigos = buscar_codigos(linha_usuario)

melhor_trajeto = None
melhor_paradas = None
codigo_escolhido = None

print("\nTestando itinerários...\n")

for cod in todos_codigos:
    traj, par = buscar_itinerario(cod)

    print(f"Código {cod} → Pontos da rota: {len(traj)} / Paradas: {len(par)}")

    if len(traj) > 0:
        melhor_trajeto = traj
        melhor_paradas = par
        codigo_escolhido = cod
        break


# Caso não tenha rota, usar somente paradas
if melhor_trajeto is None:
    print("\nSem trajeto, buscando apenas paradas...\n")
    for cod in todos_codigos:
        r = s.get(f"{API}/Parada/BuscarParadasPorLinha?codigoLinha={cod}")
        par = r.json()

        if len(par) > 0:
            melhor_paradas = [{
                "nome": p["np"],
                "lat": p["py"],
                "lng": p["px"]
            } for p in par]

            melhor_trajeto = []
            codigo_escolhido = cod
            print(f"Usando paradas do código {cod}")
            break


if melhor_paradas is None:
    raise Exception("API não retornou nenhum dado para essa linha.")


# -------- Posicionamento dos veículos --------
veiculos = buscar_posicao(codigo_escolhido)
print(f"\nVeículos encontrados agora: {len(veiculos)}")


# -------- MAPA --------

if melhor_trajeto:
    lat0, lng0 = melhor_trajeto[0]
else:
    lat0, lng0 = melhor_paradas[0]["lat"], melhor_paradas[0]["lng"]

m = folium.Map(location=[lat0, lng0], zoom_start=13)

# Rota da linha
if melhor_trajeto:
    folium.PolyLine(
        melhor_trajeto,
        weight=4,
        color="blue",
        tooltip="Rota do ônibus"
    ).add_to(m)

# Paradas
for p in melhor_paradas:
    folium.Marker(
        [p["lat"], p["lng"]],
        popup=p["nome"],
        icon=folium.Icon(color="green", icon="info-sign")
    ).add_to(m)

# Veículos (posição atual)
for v in veiculos:
    folium.Marker(
        [v["py"], v["px"]],
        popup=f"Prefixo: {v['p']}",
        icon=folium.Icon(color="red")
    ).add_to(m)


# --- SALVAR DENTRO DA MESMA PASTA DO .QMD ---

# Caminho do próprio arquivo .qmd renderizado
output_dir = "posts/post-with-code"

os.makedirs(output_dir, exist_ok=True)

caminho_mapa = os.path.join(output_dir, "onibus_mapa.html")
m.save(caminho_mapa)

# Mostrar via iframe
from IPython.display import HTML

HTML("""
<iframe src="onibus_mapa.html" width="100%" height="600px"></iframe>
""")
